name: Copilot Usage Analysis

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      analysis_name:
        description: 'Name for this analysis run (e.g., January2026, Q1-Review)'
        required: false
        type: string
        default: ''
      start_date:
        description: 'Start date (yyyy-MM-dd) - leave empty for all time'
        required: false
        type: string
        default: ''
      end_date:
        description: 'End date (yyyy-MM-dd) - leave empty for today'
        required: false
        type: string
        default: ''
      full_analysis:
        description: 'Force full re-analysis (ignore incremental tracking)'
        required: false
        type: boolean
        default: false
      validate_only:
        description: 'Only validate Git access without running analysis'
        required: false
        type: boolean
        default: false
      parallel:
        description: 'Enable parallel processing of repositories (faster)'
        required: false
        type: boolean
        default: false
      max_parallel:
        description: 'Maximum parallel threads (only used with parallel=true)'
        required: false
        type: number
        default: 4
      compare_with:
        description: 'Path to previous report JSON for comparison (e.g., reports/consolidated/Report.json)'
        required: false
        type: string
        default: ''
      config_path:
        description: 'Path to config CSV file (default: config/config.csv)'
        required: false
        type: string
        default: 'config/config.csv'
      archive_mode:
        description: 'Archive mode: skip analysis and archive current reports'
        required: false
        type: boolean
        default: false
      archive_name:
        description: 'Name for the archive (required if archive_mode is true)'
        required: false
        type: string
        default: ''
      archive_description:
        description: 'Description for the archive'
        required: false
        type: string
        default: ''

  # Optional: Schedule to run weekly on Mondays at 9 AM UTC
  # Uncomment the lines below to enable scheduled runs
  # schedule:
  #   - cron: '0 9 * * 1'

jobs:
  analyze:
    runs-on: windows-latest
    # Skip analysis job if archive_mode is true
    if: ${{ github.event.inputs.archive_mode != 'true' }}
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use the token for HTTPS authentication
          git config --global url."https://x-access-token:${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        shell: pwsh

      - name: Display input parameters
        run: |
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host "                 WORKFLOW INPUT PARAMETERS                  " -ForegroundColor Cyan
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host "Analysis Name    : ${{ github.event.inputs.analysis_name || 'Auto-generated' }}" -ForegroundColor White
          Write-Host "Start Date       : ${{ github.event.inputs.start_date || 'All time' }}" -ForegroundColor White
          Write-Host "End Date         : ${{ github.event.inputs.end_date || 'Today' }}" -ForegroundColor White
          Write-Host "Full Analysis    : ${{ github.event.inputs.full_analysis }}" -ForegroundColor White
          Write-Host "Validate Only    : ${{ github.event.inputs.validate_only }}" -ForegroundColor White
          Write-Host "Parallel         : ${{ github.event.inputs.parallel }}" -ForegroundColor White
          Write-Host "Max Parallel     : ${{ github.event.inputs.max_parallel }}" -ForegroundColor White
          Write-Host "Compare With     : ${{ github.event.inputs.compare_with || 'None' }}" -ForegroundColor White
          Write-Host "Config Path      : ${{ github.event.inputs.config_path }}" -ForegroundColor White
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Cyan
        shell: pwsh

      - name: Run Batch Analysis
        run: |
          $params = @{}
          
          # Analysis Name
          if ("${{ github.event.inputs.analysis_name }}" -ne "") {
            $params["AnalysisName"] = "${{ github.event.inputs.analysis_name }}"
          }
          
          # Start Date
          if ("${{ github.event.inputs.start_date }}" -ne "") {
            $params["StartDate"] = "${{ github.event.inputs.start_date }}"
          }
          
          # End Date
          if ("${{ github.event.inputs.end_date }}" -ne "") {
            $params["EndDate"] = "${{ github.event.inputs.end_date }}"
          }
          
          # Full Analysis (switch)
          if ("${{ github.event.inputs.full_analysis }}" -eq "true") {
            $params["FullAnalysis"] = $true
          }
          
          # Validate Only (switch)
          if ("${{ github.event.inputs.validate_only }}" -eq "true") {
            $params["ValidateOnly"] = $true
          }
          
          # Parallel (switch)
          if ("${{ github.event.inputs.parallel }}" -eq "true") {
            $params["Parallel"] = $true
          }
          
          # Max Parallel
          $maxParallel = "${{ github.event.inputs.max_parallel }}"
          if ($maxParallel -ne "" -and $maxParallel -ne "4") {
            $params["MaxParallel"] = [int]$maxParallel
          }
          
          # Compare With
          if ("${{ github.event.inputs.compare_with }}" -ne "") {
            $params["CompareWith"] = "${{ github.event.inputs.compare_with }}"
          }
          
          # Config Path
          $configPath = "${{ github.event.inputs.config_path }}"
          if ($configPath -ne "" -and $configPath -ne "config/config.csv") {
            $params["ConfigPath"] = $configPath
          }
          
          Write-Host "`nRunning analysis with parameters:" -ForegroundColor Cyan
          $params.GetEnumerator() | ForEach-Object { Write-Host "  $($_.Key): $($_.Value)" -ForegroundColor Gray }
          Write-Host ""
          
          # Run the analysis script
          & .\scripts\Run-BatchAnalysis.ps1 @params
        shell: pwsh
        env:
          # GITHUB_TOKEN is used by Analyze-GitHubPR.ps1 for API calls
          # Use REPO_ACCESS_TOKEN secret (with SSO auth) for Microsoft org repos
          # Falls back to GITHUB_TOKEN if REPO_ACCESS_TOKEN is not set
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Commit and push reports
        run: |
          # Pull latest changes first to avoid rejection
          Write-Host "Pulling latest changes from remote..." -ForegroundColor Cyan
          git pull origin ${{ github.ref_name }} --rebase --autostash
          
          # Stage files
          git add reports/ --force
          git add config/analysis-metadata.json --force 2>$null
          
          # Check if there are staged changes
          $status = git status --porcelain
          
          if ($status) {
            $analysisName = "${{ github.event.inputs.analysis_name }}"
            if (-not $analysisName) {
              $analysisName = Get-Date -Format "yyyy-MM-dd_HH-mm"
            }
            
            git commit -m "Analysis run: $analysisName [skip ci]"
            
            # Retry push up to 3 times with pull
            $maxRetries = 3
            $retryCount = 0
            $pushSuccess = $false
            
            while (-not $pushSuccess -and $retryCount -lt $maxRetries) {
              try {
                git push origin ${{ github.ref_name }}
                $pushSuccess = $true
                Write-Host "✅ Reports committed and pushed successfully" -ForegroundColor Green
              } catch {
                $retryCount++
                Write-Host "⚠️ Push failed, attempt $retryCount of $maxRetries. Pulling and retrying..." -ForegroundColor Yellow
                git pull origin ${{ github.ref_name }} --rebase
              }
            }
            
            if (-not $pushSuccess) {
              Write-Host "❌ Failed to push after $maxRetries attempts" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "⚠️ No changes to commit" -ForegroundColor Yellow
          }
        shell: pwsh

      - name: Upload Dashboard Artifact
        uses: actions/upload-artifact@v4
        if: success() && github.event.inputs.validate_only != 'true'
        with:
          name: copilot-dashboard
          path: reports/CopilotDashboard.html
          retention-days: 30

      - name: Upload Full Reports
        uses: actions/upload-artifact@v4
        if: success() && github.event.inputs.validate_only != 'true'
        with:
          name: analysis-reports
          path: |
            reports/*.html
            reports/*.csv
            reports/*.json
            reports/*.md
          retention-days: 30

  # Deploy dashboard to GitHub Pages
  deploy-dashboard:
    needs: analyze
    runs-on: ubuntu-latest
    if: success() && github.event.inputs.validate_only != 'true'
    
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          mkdir -p _site/named-archives
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          # Copy consolidated reports for dropdown functionality
          cp -r reports/consolidated/*.json _site/consolidated/ 2>/dev/null || true
          # Copy named archives for archive functionality
          if [ -d "reports/named-archives" ]; then
            cp -r reports/named-archives/* _site/named-archives/ 2>/dev/null || true
            echo "Named archives:"
            ls -la _site/named-archives/ 2>/dev/null || echo "No archives"
          fi
          echo "Dashboard prepared for deployment"
          echo "Main site files:"
          ls -la _site/
          echo "Consolidated reports:"
          ls -la _site/consolidated/ | head -20
          echo "Total consolidated reports: $(ls _site/consolidated/*.json 2>/dev/null | wc -l)"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  # Archive job - only runs when archive_mode is true
  archive:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.archive_mode == 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Archive Bundle
        run: |
          ARCHIVE_NAME="${{ github.event.inputs.archive_name }}"
          DESCRIPTION="${{ github.event.inputs.archive_description }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ -z "$ARCHIVE_NAME" ]; then
            ARCHIVE_NAME="Archive-$(date -u +%Y-%m-%d-%H%M%S)"
          fi
          
          ARCHIVE_DIR="reports/named-archives/${ARCHIVE_NAME}"
          mkdir -p "$ARCHIVE_DIR/consolidated"
          
          echo "Creating archive bundle: $ARCHIVE_NAME"
          
          REPORT_COUNT=$(find reports/consolidated -maxdepth 1 -name "ConsolidatedReport_*.json" 2>/dev/null | wc -l)
          
          if [ "$REPORT_COUNT" -eq 0 ]; then
            echo "No consolidated reports found to archive"
            exit 1
          fi
          
          echo "Archiving $REPORT_COUNT consolidated reports..."
          
          cp reports/consolidated/ConsolidatedReport_*.json "$ARCHIVE_DIR/consolidated/" 2>/dev/null || true
          cp reports/Batch-Analysis-Summary.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Batch-Analysis-Summary.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Branch-Level-Summary_*.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/CopilotDashboard.html "$ARCHIVE_DIR/" 2>/dev/null || true
          
          REPORTS_LIST=""
          for f in "$ARCHIVE_DIR/consolidated/"*.json; do
            [ -f "$f" ] || continue
            if [ -n "$REPORTS_LIST" ]; then
              REPORTS_LIST="$REPORTS_LIST,"
            fi
            REPORTS_LIST="$REPORTS_LIST\"$(basename $f)\""
          done
          
          cat > "$ARCHIVE_DIR/archive-info.json" << EOF
{"name":"$ARCHIVE_NAME","description":"$DESCRIPTION","createdAt":"$TIMESTAMP","reportCount":$REPORT_COUNT,"reports":[$REPORTS_LIST],"createdBy":"${{ github.actor }}"}
EOF
          
          echo "Archive bundle created with $REPORT_COUNT reports"
          ls -la "$ARCHIVE_DIR/"

      - name: Clear Current Reports
        run: |
          echo "Clearing current reports after archiving..."
          rm -f reports/consolidated/ConsolidatedReport_*.json
          rm -f reports/consolidated/*.json
          rm -f reports/Batch-Analysis-Summary.csv
          rm -f reports/Batch-Analysis-Summary.md
          rm -f reports/Branch-Level-Summary_*.csv
          rm -f reports/Consolidated-Analysis_*.json
          echo "All current reports cleared"

      - name: Update Archive Index
        run: |
          ARCHIVES_DIR="reports/named-archives"
          INDEX_FILE="$ARCHIVES_DIR/index.json"
          mkdir -p "$ARCHIVES_DIR"
          
          echo "[" > "$INDEX_FILE"
          first=true
          for dir in "$ARCHIVES_DIR"/*/; do
            if [ -d "$dir" ] && [ -f "${dir}archive-info.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> "$INDEX_FILE"
              fi
              cat "${dir}archive-info.json" >> "$INDEX_FILE"
            fi
          done
          echo "]" >> "$INDEX_FILE"
          
          echo "Archive index updated"
          cat "$INDEX_FILE"

      - name: Commit Archive
        run: |
          git add reports/named-archives/
          git add reports/consolidated/
          git add reports/Batch-Analysis-Summary.csv || true
          git add reports/Batch-Analysis-Summary.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Archive: ${{ github.event.inputs.archive_name }}"
            
            for i in 1 2 3; do
              if git push; then
                echo "Archive committed and pushed"
                exit 0
              fi
              echo "Push failed, attempt $i. Retrying..."
              git pull --rebase
            done
            
            echo "Failed to push after 3 attempts"
            exit 1
          fi

  # Deploy after archive (only when archive_mode is true)
  deploy-archive:
    needs: archive
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.archive_mode == 'true' }}
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          mkdir -p _site/named-archives
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          cp -r reports/consolidated/*.json _site/consolidated/ 2>/dev/null || true
          if [ -d "reports/named-archives" ]; then
            cp -r reports/named-archives/* _site/named-archives/ 2>/dev/null || true
          fi
          echo "Dashboard prepared for deployment"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4