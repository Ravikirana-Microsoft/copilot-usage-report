name: Copilot Usage Analysis

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      # === CONFIG UPDATE INPUTS ===
      update_config:
        description: 'Update Config Mode: Save new config.json from dashboard'
        required: false
        type: string
        default: 'false'
      config_data:
        description: 'JSON config data (used with update_config=true)'
        required: false
        type: string
        default: ''
      # === RESET MODE INPUTS ===
      reset_mode:
        description: 'Reset Mode: Archive all reports and clear dashboard'
        required: false
        type: boolean
        default: false
      # === ARCHIVE MODE INPUTS ===
      archive_mode:
        description: 'Archive Mode: Bundle all reports into named archive'
        required: false
        type: boolean
        default: false
      archive_name:
        description: 'Archive name (required if archive_mode=true)'
        required: false
        type: string
        default: ''
      archive_description:
        description: 'Archive description (optional)'
        required: false
        type: string
        default: ''
      # === ANALYSIS MODE INPUTS ===
      analysis_name:
        description: 'Name for this analysis run (e.g., January2026, Q1-Review)'
        required: false
        type: string
        default: ''
      start_date:
        description: 'Start date (yyyy-MM-dd) - leave empty for all time'
        required: false
        type: string
        default: ''
      end_date:
        description: 'End date (yyyy-MM-dd) - leave empty for today'
        required: false
        type: string
        default: ''
      full_analysis:
        description: 'Force full re-analysis (ignore incremental tracking)'
        required: false
        type: boolean
        default: false
      validate_only:
        description: 'Only validate Git access without running analysis'
        required: false
        type: boolean
        default: false
      parallel:
        description: 'Enable parallel processing of repositories (faster)'
        required: false
        type: boolean
        default: false
      max_parallel:
        description: 'Maximum parallel threads (only used with parallel=true)'
        required: false
        type: number
        default: 4
      compare_with:
        description: 'Path to previous report JSON for comparison (e.g., reports/consolidated/Report.json)'
        required: false
        type: string
        default: ''
      config_path:
        description: 'Path to config CSV file (default: config/config.csv)'
        required: false
        type: string
        default: 'config/config.csv'

  # Optional: Schedule to run weekly on Mondays at 9 AM UTC
  # Uncomment the lines below to enable scheduled runs
  # schedule:
  #   - cron: '0 9 * * 1'

# ============================================
# CONCURRENCY CONTROL
# Prevents merge conflicts when multiple runs overlap
# ============================================
concurrency:
  group: copilot-analysis-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel in-progress runs, just queue

jobs:
  # ============================================
  # CONFIG UPDATE JOB - Runs when update_config=true
  # ============================================
  update-config:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_config == 'true' }}
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update config.json
        run: |
          echo "ðŸ“ Updating config.json..."
          CONFIG_DATA='${{ github.event.inputs.config_data }}'
          
          if [ -z "$CONFIG_DATA" ]; then
            echo "âŒ No config data provided"
            exit 1
          fi
          
          # Write the config data to file
          echo "$CONFIG_DATA" > config/config.json
          
          # Pretty print for verification
          echo "âœ… Config updated:"
          cat config/config.json | head -50

      - name: Generate CSV for backward compatibility
        run: |
          python3 -c "
          import json, csv
          with open('config/config.json', 'r') as f:
              config = json.load(f)
          with open('config/config.csv', 'w', newline='') as f:
              writer = csv.writer(f)
              writer.writerow(['ApplicationName', 'GitUrl', 'Branches', 'ExcludePaths', 'Owner', 'Team', 'TargetAIPercent', 'Enabled'])
              for repo in config.get('repositories', []):
                  branches = ','.join(repo.get('branches', ['main'])) if isinstance(repo.get('branches'), list) else repo.get('branches', 'main')
                  excludePaths = ','.join(repo.get('excludePaths', [])) if isinstance(repo.get('excludePaths'), list) else (repo.get('excludePaths') or '')
                  writer.writerow([repo.get('applicationName', ''), repo.get('gitUrl', ''), branches, excludePaths, repo.get('owner', ''), repo.get('team', ''), repo.get('targetAIPercent', 25), 'true' if repo.get('enabled', True) else 'false'])
          print(f'Generated config.csv with {len(config.get(\"repositories\", []))} repositories')
          "

      - name: Commit and push config
        run: |
          git add config/config.json config/config.csv
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "âš™ï¸ Update config from Dashboard"
            
            for i in 1 2 3; do
              if git push; then
                echo "âœ… Config committed and pushed"
                exit 0
              fi
              echo "âš ï¸ Push failed, attempt $i. Retrying..."
              git pull --rebase
            done
            
            echo "âŒ Failed to push after 3 attempts"
            exit 1
          fi

  # ============================================
  # ARCHIVE JOB - Runs when archive_mode=true
  # ============================================
  archive:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.archive_mode == 'true' }}
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate Archive Name
        run: |
          ARCHIVE_NAME="${{ github.event.inputs.archive_name }}"
          if [ -z "$ARCHIVE_NAME" ]; then
            echo "Î“Â¥Ã® Archive name is required when archive_mode is true"
            exit 1
          fi
          # Sanitize name (alphanumeric, dash, underscore only)
          SANITIZED=$(echo "$ARCHIVE_NAME" | sed 's/[^a-zA-Z0-9_-]/-/g' | sed 's/-\+/-/g')
          echo "Archive name: $SANITIZED"
          echo "ARCHIVE_NAME=$SANITIZED" >> $GITHUB_ENV

      - name: Create Archive Bundle
        run: |
          ARCHIVE_NAME="${{ env.ARCHIVE_NAME }}"
          DESCRIPTION="${{ github.event.inputs.archive_description }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Create archive directory
          ARCHIVE_DIR="reports/named-archives/${ARCHIVE_NAME}"
          mkdir -p "$ARCHIVE_DIR/consolidated"
          
          echo "â‰¡Æ’Ã´Âª Creating archive: $ARCHIVE_NAME"
          
          # Count reports
          REPORT_COUNT=$(ls reports/consolidated/ConsolidatedReport_*.json 2>/dev/null | wc -l || echo "0")
          
          if [ "$REPORT_COUNT" -eq "0" ]; then
            echo "Î“ÃœÃ¡âˆ©â••Ã… No consolidated reports found - creating empty archive marker"
            REPORT_COUNT=0
          else
            echo "â‰¡Æ’Ã´Ã¤ Archiving $REPORT_COUNT consolidated reports..."
            # Copy ALL consolidated reports to archive
            cp reports/consolidated/ConsolidatedReport_*.json "$ARCHIVE_DIR/consolidated/" 2>/dev/null || true
          fi
          
          # Copy summary files
          cp reports/Batch-Analysis-Summary.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Batch-Analysis-Summary.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Branch-Level-Summary_*.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          
          # Copy dashboard snapshot
          cp reports/CopilotDashboard.html "$ARCHIVE_DIR/" 2>/dev/null || true
          
          # Build reports list for metadata
          if [ -d "$ARCHIVE_DIR/consolidated" ] && [ "$(ls -A $ARCHIVE_DIR/consolidated/*.json 2>/dev/null)" ]; then
            REPORTS_LIST=$(ls "$ARCHIVE_DIR/consolidated/"*.json 2>/dev/null | while read f; do basename "$f"; done | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            REPORTS_LIST="[]"
          fi
          
          # Create archive metadata
          echo "{" > "$ARCHIVE_DIR/archive-info.json"
          echo "  \"name\": \"$ARCHIVE_NAME\"," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"description\": \"$DESCRIPTION\"," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"createdAt\": \"$TIMESTAMP\"," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"reportCount\": $REPORT_COUNT," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"reports\": $REPORTS_LIST," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"createdBy\": \"${{ github.actor }}\"" >> "$ARCHIVE_DIR/archive-info.json"
          echo "}" >> "$ARCHIVE_DIR/archive-info.json"
          
          echo "Î“Â£Ã  Archive created: $ARCHIVE_DIR"
          ls -la "$ARCHIVE_DIR/"

      - name: Clear Current Reports
        run: |
          echo "â‰¡Æ’Ã¹Ã¦âˆ©â••Ã… Clearing current consolidated reports..."
          
          # Remove all consolidated reports
          rm -f reports/consolidated/ConsolidatedReport_*.json 2>/dev/null || true
          
          # Remove summary files (keep structure)
          rm -f reports/Batch-Analysis-Summary.csv 2>/dev/null || true
          rm -f reports/Batch-Analysis-Summary.md 2>/dev/null || true
          rm -f reports/Branch-Level-Summary_*.csv 2>/dev/null || true
          rm -f reports/Consolidated-Analysis_*.json 2>/dev/null || true
          
          # Create placeholder to keep folder
          echo "Reports archived to named-archives/${{ env.ARCHIVE_NAME }}" > reports/consolidated/README.md
          
          echo "Î“Â£Ã  Current reports cleared"

      - name: Update Dashboard to Show No Data
        run: |
          DASHBOARD="reports/CopilotDashboard.html"
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S')
          
          if [ -f "$DASHBOARD" ]; then
            echo "â‰¡Æ’Ã´Ã¨ Updating dashboard to show no data state..."
            
            # Use perl for multi-line regex - clear archivedReports array
            perl -i -0pe 's/archivedReports:\s*\[[\s\S]*?\],/archivedReports: [],/g' "$DASHBOARD"
            
            # Use sed to clear latestReport
            sed -i 's/latestReport: "[^"]*"/latestReport: ""/g' "$DASHBOARD"
            
            # Update lastUpdated timestamp
            sed -i "s/lastUpdated: \"[^\"]*\"/lastUpdated: \"$TIMESTAMP\"/g" "$DASHBOARD"
            
            # For EMBEDDED_DATA, set to null using perl for multi-line
            perl -i -0pe 's/const EMBEDDED_DATA = \{[\s\S]*?\};/const EMBEDDED_DATA = null;/g' "$DASHBOARD" || true
            
            echo "Î“Â£Ã  Dashboard updated to show no data"
            
            # Verify the update
            echo "--- Verifying REPORT_CONFIG ---"
            grep -A5 "const REPORT_CONFIG" "$DASHBOARD" | head -10
          else
            echo "Î“ÃœÃ¡âˆ©â••Ã… Dashboard not found at $DASHBOARD"
          fi

      - name: Update Archive Index
        run: |
          ARCHIVES_DIR="reports/named-archives"
          INDEX_FILE="$ARCHIVES_DIR/index.json"
          
          mkdir -p "$ARCHIVES_DIR"
          
          # Build index from all archive directories
          echo "[" > "$INDEX_FILE"
          first=true
          for dir in "$ARCHIVES_DIR"/*/; do
            if [ -d "$dir" ] && [ -f "${dir}archive-info.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> "$INDEX_FILE"
              fi
              cat "${dir}archive-info.json" >> "$INDEX_FILE"
            fi
          done
          echo "]" >> "$INDEX_FILE"
          
          echo "â‰¡Æ’Ã´Ã¯ Archive index updated:"
          cat "$INDEX_FILE"

      - name: Commit and Push Archive
        run: |
          git add reports/named-archives/
          git add reports/consolidated/
          git add reports/CopilotDashboard.html
          git add reports/*.csv 2>/dev/null || true
          git add reports/*.md 2>/dev/null || true
          git add reports/*.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "Î“ÃœÃ¡âˆ©â••Ã… No changes to commit"
          else
            git commit -m "â‰¡Æ’Ã´Âª Archive: ${{ env.ARCHIVE_NAME }}"
            
            # Retry push
            for i in 1 2 3; do
              if git push; then
                echo "Î“Â£Ã  Archive committed and pushed"
                exit 0
              fi
              echo "Î“ÃœÃ¡âˆ©â••Ã… Push failed, attempt $i. Retrying..."
              git pull --rebase
            done
            
            echo "Î“Â¥Ã® Failed to push after 3 attempts"
            exit 1
          fi

  # Deploy after archive
  deploy-after-archive:
    needs: archive
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.archive_mode == 'true' }}
    
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes (with retry)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling latest changes..."
            if git pull origin ${{ github.ref_name }}; then
              echo "Î“Â£Ã  Pull successful"
              exit 0
            fi
            echo "Î“ÃœÃ¡âˆ©â••Ã… Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Î“Â¥Ã® Failed to pull after 5 attempts"
          exit 1

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          mkdir -p _site/named-archives
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          cp -r reports/consolidated/*.json _site/consolidated/ 2>/dev/null || true
          if [ -d "reports/named-archives" ]; then
            cp -r reports/named-archives/* _site/named-archives/ 2>/dev/null || true
          fi
          echo "Dashboard prepared for deployment"
          ls -la _site/
          ls -la _site/named-archives/ 2>/dev/null || echo "Archives ready"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================
  # RESET JOB - Runs when reset_mode=true
  # Archives all reports and clears dashboard
  # ============================================
  reset:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.reset_mode == 'true' }}
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Archive Current Reports
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
          ARCHIVE_DIR="reports/consolidated/archive/${TIMESTAMP}"
          
          echo "ðŸ“¦ Creating reset archive: $ARCHIVE_DIR"
          
          # Create archive directory
          mkdir -p "$ARCHIVE_DIR"
          
          # Count and archive reports
          REPORT_COUNT=$(ls reports/consolidated/ConsolidatedReport_*.json 2>/dev/null | wc -l || echo "0")
          
          if [ "$REPORT_COUNT" -eq "0" ]; then
            echo "âš ï¸ No consolidated reports found to archive"
          else
            echo "ðŸ“„ Archiving $REPORT_COUNT consolidated reports..."
            mv reports/consolidated/ConsolidatedReport_*.json "$ARCHIVE_DIR/" 2>/dev/null || true
          fi
          
          # Create archive metadata
          echo "{" > "$ARCHIVE_DIR/archive-info.json"
          echo "  \"archivedAt\": \"$TIMESTAMP\"," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"reportCount\": $REPORT_COUNT," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"reason\": \"Reset from Dashboard\"," >> "$ARCHIVE_DIR/archive-info.json"
          echo "  \"triggeredBy\": \"${{ github.actor }}\"" >> "$ARCHIVE_DIR/archive-info.json"
          echo "}" >> "$ARCHIVE_DIR/archive-info.json"
          
          echo "âœ… Reports archived to $ARCHIVE_DIR"

      - name: Clear Summary Files
        run: |
          echo "ðŸ—‘ï¸ Clearing summary files..."
          rm -f reports/Batch-Analysis-Summary.csv 2>/dev/null || true
          rm -f reports/Batch-Analysis-Summary.md 2>/dev/null || true
          rm -f reports/Branch-Level-Summary_*.csv 2>/dev/null || true
          rm -f reports/Consolidated-Analysis_*.json 2>/dev/null || true
          echo "âœ… Summary files cleared"

      - name: Create Empty Index
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "{" > reports/consolidated/index.json
          echo "  \"reports\": []," >> reports/consolidated/index.json
          echo "  \"lastUpdated\": \"$TIMESTAMP\"," >> reports/consolidated/index.json
          echo "  \"resetReason\": \"Manual reset via Dashboard\"" >> reports/consolidated/index.json
          echo "}" >> reports/consolidated/index.json
          echo "âœ… Empty index.json created"

      - name: Update Dashboard
        run: |
          DASHBOARD="reports/CopilotDashboard.html"
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S')
          
          if [ -f "$DASHBOARD" ]; then
            echo "ðŸ“Š Updating dashboard to show no data state..."
            
            # Clear archivedReports array using perl
            perl -i -0pe 's/archivedReports:\s*\[[\s\S]*?\],/archivedReports: [],/g' "$DASHBOARD"
            
            # Clear latestReport
            sed -i 's/latestReport: "[^"]*"/latestReport: ""/g' "$DASHBOARD"
            
            # Update lastUpdated timestamp
            sed -i "s/lastUpdated: \"[^\"]*\"/lastUpdated: \"$TIMESTAMP\"/g" "$DASHBOARD"
            
            # Clear EMBEDDED_DATA
            perl -i -0pe 's/const EMBEDDED_DATA = \{[\s\S]*?\};/const EMBEDDED_DATA = null;/g' "$DASHBOARD" || true
            
            echo "âœ… Dashboard updated"
          else
            echo "âš ï¸ Dashboard not found"
          fi

      - name: Commit and Push Reset
        run: |
          git add reports/
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "ðŸ”„ Reset: Clear all reports for new analysis"
            
            for i in 1 2 3; do
              if git push; then
                echo "âœ… Reset committed and pushed"
                exit 0
              fi
              echo "âš ï¸ Push failed, attempt $i. Retrying..."
              git pull --rebase
            done
            
            echo "âŒ Failed to push after 3 attempts"
            exit 1
          fi

  # Deploy after reset
  deploy-after-reset:
    needs: reset
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.reset_mode == 'true' }}
    
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: |
          for i in 1 2 3 4 5; do
            if git pull origin ${{ github.ref_name }}; then
              echo "âœ… Pull successful"
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          cp reports/CopilotDashboard.html _site/index.html
          cp reports/consolidated/index.json _site/consolidated/ 2>/dev/null || true
          echo "Dashboard prepared for deployment"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================
  # ANALYSIS JOB - Runs when not archive/reset/config-update mode
  # ============================================
  analyze:
    runs-on: windows-latest
    if: ${{ github.event.inputs.archive_mode != 'true' && github.event.inputs.reset_mode != 'true' && github.event.inputs.update_config != 'true' }}
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use the token for HTTPS authentication
          git config --global url."https://x-access-token:${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        shell: pwsh

      - name: Display input parameters
        run: |
          Write-Host "Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰" -ForegroundColor Cyan
          Write-Host "                 WORKFLOW INPUT PARAMETERS                  " -ForegroundColor Cyan
          Write-Host "Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰" -ForegroundColor Cyan
          Write-Host "Analysis Name    : ${{ github.event.inputs.analysis_name || 'Auto-generated' }}" -ForegroundColor White
          Write-Host "Start Date       : ${{ github.event.inputs.start_date || 'All time' }}" -ForegroundColor White
          Write-Host "End Date         : ${{ github.event.inputs.end_date || 'Today' }}" -ForegroundColor White
          Write-Host "Full Analysis    : ${{ github.event.inputs.full_analysis }}" -ForegroundColor White
          Write-Host "Validate Only    : ${{ github.event.inputs.validate_only }}" -ForegroundColor White
          Write-Host "Parallel         : ${{ github.event.inputs.parallel }}" -ForegroundColor White
          Write-Host "Max Parallel     : ${{ github.event.inputs.max_parallel }}" -ForegroundColor White
          Write-Host "Compare With     : ${{ github.event.inputs.compare_with || 'None' }}" -ForegroundColor White
          Write-Host "Config Path      : ${{ github.event.inputs.config_path }}" -ForegroundColor White
          Write-Host "Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰Î“Ã²Ã‰" -ForegroundColor Cyan
        shell: pwsh

      - name: Run Batch Analysis
        run: |
          $params = @{}
          
          # Analysis Name
          if ("${{ github.event.inputs.analysis_name }}" -ne "") {
            $params["AnalysisName"] = "${{ github.event.inputs.analysis_name }}"
          }
          
          # Start Date
          if ("${{ github.event.inputs.start_date }}" -ne "") {
            $params["StartDate"] = "${{ github.event.inputs.start_date }}"
          }
          
          # End Date
          if ("${{ github.event.inputs.end_date }}" -ne "") {
            $params["EndDate"] = "${{ github.event.inputs.end_date }}"
          }
          
          # Full Analysis (switch)
          if ("${{ github.event.inputs.full_analysis }}" -eq "true") {
            $params["FullAnalysis"] = $true
          }
          
          # Validate Only (switch)
          if ("${{ github.event.inputs.validate_only }}" -eq "true") {
            $params["ValidateOnly"] = $true
          }
          
          # Parallel (switch)
          if ("${{ github.event.inputs.parallel }}" -eq "true") {
            $params["Parallel"] = $true
          }
          
          # Max Parallel
          $maxParallel = "${{ github.event.inputs.max_parallel }}"
          if ($maxParallel -ne "" -and $maxParallel -ne "4") {
            $params["MaxParallel"] = [int]$maxParallel
          }
          
          # Compare With
          if ("${{ github.event.inputs.compare_with }}" -ne "") {
            $params["CompareWith"] = "${{ github.event.inputs.compare_with }}"
          }
          
          # Config Path
          $configPath = "${{ github.event.inputs.config_path }}"
          if ($configPath -ne "" -and $configPath -ne "config/config.csv") {
            $params["ConfigPath"] = $configPath
          }
          
          Write-Host "`nRunning analysis with parameters:" -ForegroundColor Cyan
          $params.GetEnumerator() | ForEach-Object { Write-Host "  $($_.Key): $($_.Value)" -ForegroundColor Gray }
          Write-Host ""
          
          # Run the analysis script
          & .\scripts\Run-BatchAnalysis.ps1 @params
        shell: pwsh
        env:
          # GITHUB_TOKEN is used by Analyze-GitHubPR.ps1 for API calls
          # Use REPO_ACCESS_TOKEN secret (with SSO auth) for Microsoft org repos
          # Falls back to GITHUB_TOKEN if REPO_ACCESS_TOKEN is not set
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Commit and push reports
        run: |
          # Pull latest changes first to avoid rejection
          Write-Host "Pulling latest changes from remote..." -ForegroundColor Cyan
          git pull origin ${{ github.ref_name }} --rebase --autostash
          
          # Stage files
          git add reports/ --force
          git add config/analysis-metadata.json --force 2>$null
          
          # Check if there are staged changes
          $status = git status --porcelain
          
          if ($status) {
            $analysisName = "${{ github.event.inputs.analysis_name }}"
            if (-not $analysisName) {
              $analysisName = Get-Date -Format "yyyy-MM-dd_HH-mm"
            }
            
            git commit -m "Analysis run: $analysisName [skip ci]"
            
            # Retry push up to 3 times with pull
            $maxRetries = 3
            $retryCount = 0
            $pushSuccess = $false
            
            while (-not $pushSuccess -and $retryCount -lt $maxRetries) {
              try {
                git push origin ${{ github.ref_name }}
                $pushSuccess = $true
                Write-Host "Î“Â£Ã  Reports committed and pushed successfully" -ForegroundColor Green
              } catch {
                $retryCount++
                Write-Host "Î“ÃœÃ¡âˆ©â••Ã… Push failed, attempt $retryCount of $maxRetries. Pulling and retrying..." -ForegroundColor Yellow
                git pull origin ${{ github.ref_name }} --rebase
              }
            }
            
            if (-not $pushSuccess) {
              Write-Host "Î“Â¥Ã® Failed to push after $maxRetries attempts" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "Î“ÃœÃ¡âˆ©â••Ã… No changes to commit" -ForegroundColor Yellow
          }
        shell: pwsh

      - name: Upload Dashboard Artifact
        uses: actions/upload-artifact@v4
        if: success() && github.event.inputs.validate_only != 'true'
        with:
          name: copilot-dashboard
          path: reports/CopilotDashboard.html
          retention-days: 30

      - name: Upload Full Reports
        uses: actions/upload-artifact@v4
        if: success() && github.event.inputs.validate_only != 'true'
        with:
          name: analysis-reports
          path: |
            reports/*.html
            reports/*.csv
            reports/*.json
            reports/*.md
          retention-days: 30

  # Deploy dashboard to GitHub Pages
  deploy-dashboard:
    needs: analyze
    runs-on: ubuntu-latest
    if: ${{ success() && github.event.inputs.validate_only != 'true' && github.event.inputs.archive_mode != 'true' && github.event.inputs.reset_mode != 'true' && github.event.inputs.update_config != 'true' }}
    
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes (with retry)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling latest changes..."
            if git pull origin ${{ github.ref_name }}; then
              echo "Î“Â£Ã  Pull successful"
              exit 0
            fi
            echo "Î“ÃœÃ¡âˆ©â••Ã… Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Î“Â¥Ã® Failed to pull after 5 attempts"
          exit 1

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          mkdir -p _site/named-archives
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          # Copy consolidated reports for dropdown functionality
          cp -r reports/consolidated/*.json _site/consolidated/ 2>/dev/null || true
          # Copy named archives for archive functionality
          if [ -d "reports/named-archives" ]; then
            cp -r reports/named-archives/* _site/named-archives/ 2>/dev/null || true
            echo "Named archives:"
            ls -la _site/named-archives/ 2>/dev/null || echo "No archives"
          fi
          echo "Dashboard prepared for deployment"
          echo "Main site files:"
          ls -la _site/
          echo "Consolidated reports:"
          ls -la _site/consolidated/ | head -20
          echo "Total consolidated reports: $(ls _site/consolidated/*.json 2>/dev/null | wc -l)"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
