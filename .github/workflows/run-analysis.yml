name: Copilot Usage Analysis

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      analysis_name:
        description: 'Name for this analysis run (e.g., January2026, Q1-Review)'
        required: false
        default: ''
      start_date:
        description: 'Start date (yyyy-MM-dd) - leave empty for all time'
        required: false
        default: ''
      end_date:
        description: 'End date (yyyy-MM-dd) - leave empty for today'
        required: false
        default: ''
      full_analysis:
        description: 'Force full re-analysis (ignore incremental)'
        required: false
        type: boolean
        default: false

  # Optional: Schedule to run weekly on Mondays at 9 AM UTC
  # Uncomment the lines below to enable scheduled runs
  # schedule:
  #   - cron: '0 9 * * 1'

jobs:
  analyze:
    runs-on: windows-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git credentials for cloning public repos
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
        shell: pwsh

      - name: Run Batch Analysis
        run: |
          $params = @{}
          
          if ("${{ github.event.inputs.analysis_name }}" -ne "") {
            $params["AnalysisName"] = "${{ github.event.inputs.analysis_name }}"
          }
          
          if ("${{ github.event.inputs.start_date }}" -ne "") {
            $params["StartDate"] = "${{ github.event.inputs.start_date }}"
          }
          
          if ("${{ github.event.inputs.end_date }}" -ne "") {
            $params["EndDate"] = "${{ github.event.inputs.end_date }}"
          }
          
          if ("${{ github.event.inputs.full_analysis }}" -eq "true") {
            $params["FullAnalysis"] = $true
          }
          
          Write-Host "Running analysis with parameters:" -ForegroundColor Cyan
          $params | Format-Table -AutoSize
          
          # Run the analysis script
          & .\scripts\Run-BatchAnalysis.ps1 @params
        shell: pwsh
        env:
          # For public repos, GITHUB_TOKEN works. For private repos, use REPO_ACCESS_TOKEN
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Commit and push reports
        run: |
          git add reports/
          git add config/analysis-metadata.json -f 2>$null
          
          # Check if there are staged changes
          $status = git status --porcelain
          
          if ($status) {
            $analysisName = "${{ github.event.inputs.analysis_name }}"
            if (-not $analysisName) {
              $analysisName = Get-Date -Format "yyyy-MM-dd_HH-mm"
            }
            git commit -m "Analysis run: $analysisName [skip ci]"
            git push
            Write-Host "✅ Reports committed and pushed successfully" -ForegroundColor Green
          } else {
            Write-Host "⚠️ No changes to commit" -ForegroundColor Yellow
          }
        shell: pwsh

      - name: Upload Dashboard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-dashboard
          path: reports/CopilotDashboard.html
          retention-days: 30

      - name: Upload Full Reports
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            reports/*.html
            reports/*.csv
            reports/*.json
            reports/*.md
          retention-days: 30

  # Deploy dashboard to GitHub Pages
  deploy-dashboard:
    needs: analyze
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          echo "Dashboard prepared for deployment"
          ls -la _site/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
