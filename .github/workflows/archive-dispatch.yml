name: Archive Reports

on:
  push:
    paths:
      - '.github/workflows/archive-dispatch.yml'
  repository_dispatch:
    types: [create-archive]

jobs:
  archive:
    runs-on: ubuntu-latest
    # Only run on repository_dispatch, not on push
    if: github.event_name == 'repository_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Archive Bundle
        run: |
          ARCHIVE_NAME="${{ github.event.client_payload.archive_name }}"
          DESCRIPTION="${{ github.event.client_payload.description }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ -z "$ARCHIVE_NAME" ]; then
            ARCHIVE_NAME="Archive-$(date -u +%Y-%m-%d-%H%M%S)"
          fi
          
          ARCHIVE_DIR="reports/named-archives/${ARCHIVE_NAME}"
          mkdir -p "$ARCHIVE_DIR/consolidated"
          
          echo "Creating archive bundle: $ARCHIVE_NAME"
          
          REPORT_COUNT=$(find reports/consolidated -maxdepth 1 -name "ConsolidatedReport_*.json" 2>/dev/null | wc -l)
          
          if [ "$REPORT_COUNT" -eq 0 ]; then
            echo "No consolidated reports found to archive"
            exit 1
          fi
          
          echo "Archiving $REPORT_COUNT consolidated reports..."
          
          cp reports/consolidated/ConsolidatedReport_*.json "$ARCHIVE_DIR/consolidated/" 2>/dev/null || true
          cp reports/Batch-Analysis-Summary.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Batch-Analysis-Summary.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/Branch-Level-Summary_*.csv "$ARCHIVE_DIR/" 2>/dev/null || true
          cp reports/CopilotDashboard.html "$ARCHIVE_DIR/" 2>/dev/null || true
          
          REPORTS_LIST=""
          for f in "$ARCHIVE_DIR/consolidated/"*.json; do
            [ -f "$f" ] || continue
            if [ -n "$REPORTS_LIST" ]; then
              REPORTS_LIST="$REPORTS_LIST,"
            fi
            REPORTS_LIST="$REPORTS_LIST\"$(basename $f)\""
          done
          
          cat > "$ARCHIVE_DIR/archive-info.json" << EOF
{"name":"$ARCHIVE_NAME","description":"$DESCRIPTION","createdAt":"$TIMESTAMP","reportCount":$REPORT_COUNT,"reports":[$REPORTS_LIST],"createdBy":"${{ github.actor }}"}
EOF
          
          echo "Archive bundle created with $REPORT_COUNT reports"
          ls -la "$ARCHIVE_DIR/"

      - name: Clear Current Reports
        run: |
          echo "Clearing current reports after archiving..."
          rm -f reports/consolidated/ConsolidatedReport_*.json
          rm -f reports/consolidated/*.json
          rm -f reports/Batch-Analysis-Summary.csv
          rm -f reports/Batch-Analysis-Summary.md
          rm -f reports/Branch-Level-Summary_*.csv
          rm -f reports/Consolidated-Analysis_*.json
          echo "All current reports cleared"

      - name: Update Archive Index
        run: |
          ARCHIVES_DIR="reports/named-archives"
          INDEX_FILE="$ARCHIVES_DIR/index.json"
          mkdir -p "$ARCHIVES_DIR"
          
          echo "[" > "$INDEX_FILE"
          first=true
          for dir in "$ARCHIVES_DIR"/*/; do
            if [ -d "$dir" ] && [ -f "${dir}archive-info.json" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> "$INDEX_FILE"
              fi
              cat "${dir}archive-info.json" >> "$INDEX_FILE"
            fi
          done
          echo "]" >> "$INDEX_FILE"
          
          echo "Archive index updated"
          cat "$INDEX_FILE"

      - name: Commit Archive
        run: |
          git add reports/named-archives/
          git add reports/consolidated/
          git add reports/Batch-Analysis-Summary.csv || true
          git add reports/Batch-Analysis-Summary.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            ARCHIVE_NAME="${{ github.event.client_payload.archive_name }}"
            git commit -m "Archive: ${ARCHIVE_NAME:-Auto}"
            
            for i in 1 2 3; do
              if git push; then
                echo "Archive committed and pushed"
                exit 0
              fi
              echo "Push failed, attempt $i. Retrying..."
              git pull --rebase
            done
            
            echo "Failed to push after 3 attempts"
            exit 1
          fi

  deploy:
    needs: archive
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare dashboard for deployment
        run: |
          mkdir -p _site
          mkdir -p _site/consolidated
          mkdir -p _site/named-archives
          cp reports/CopilotDashboard.html _site/index.html
          cp -r reports/*.json _site/ 2>/dev/null || true
          cp -r reports/*.csv _site/ 2>/dev/null || true
          cp -r reports/consolidated/*.json _site/consolidated/ 2>/dev/null || true
          if [ -d "reports/named-archives" ]; then
            cp -r reports/named-archives/* _site/named-archives/ 2>/dev/null || true
          fi
          echo "Dashboard prepared for deployment"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
